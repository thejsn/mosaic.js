/**
 * Mosaic.js
 *  * Released under the MIT License.
 */
var Mosaic=function(){"use strict";var t="undefined"!=typeof window?window:"undefined"!=typeof global?global:this,e={};e.classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},e.createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var n=function(){function t(n){var i=arguments.length<=1||void 0===arguments[1]?10:arguments[1],s=arguments.length<=2||void 0===arguments[2]?10:arguments[2],o=arguments.length<=3||void 0===arguments[3]?1:arguments[3];e.classCallCheck(this,t),this._aspectRatio=o,this._averageColor=0,this._width=0,this._height=0,this._image,this._canvas=document.createElement("canvas"),this._context=this._canvas.getContext("2d"),this.setSize(i,s,o),n&&this.setImage(n)}return e.createClass(t,[{key:"_getBounds",value:function(){var t=this._image.naturalWidth,e=this._image.naturalHeight,n=0,i=0,s=t,o=e,r=0,h=0,a=this._width,u=this._height,c=this._aspectRatio,l=s/o,_=a*c/u;return l>_?(s=o*_,n=.5*t-.5*s):(o=s/_,i=.5*e-.5*o),{sx:n,sy:i,sw:s,sh:o,dx:r,dy:h,dw:a,dh:u}}},{key:"_drawImage",value:function(){if(this._width>0&&this._height>0&&this._image){var t=this._getBounds();this._context.drawImage(this._image,t.sx,t.sy,t.sw,t.sh,t.dx,t.dy,t.dw,t.dh),this._calculateAverageColor()}}},{key:"_calculateAverageColor",value:function(){for(var t=this.getImageData(),e=t.length/4,n=0,i=0,s=0,o=0;4*e>o;o+=4)n+=t[o],i+=t[o+1],s+=t[o+2];return n/=e,i/=e,s/=e,this._averageColor=n<<16|i<<8|s,this._averageColor}},{key:"setSize",value:function(t,e){var n=arguments.length<=2||void 0===arguments[2]?1:arguments[2];this._aspectRatio=n,this._canvas.width=this._width=Number(t),this._canvas.height=this._height=Number(e),this._drawImage()}},{key:"getImageData",value:function(){return this._context.getImageData(0,0,this._width,this._height).data}},{key:"setImage",value:function(t){this._image=t,this._drawImage()}},{key:"width",get:function(){return this._image.naturalWidth}},{key:"height",get:function(){return this._image.naturalHeight}},{key:"canvas",get:function(){return this._canvas}},{key:"context",get:function(){return this._context}},{key:"averageColor",get:function(){return this._averageColor}}]),t}(),i=function(){function t(){e.classCallCheck(this,t),this._loadCount=0,this._completeCount=0}return e.createClass(t,[{key:"loadComplete",value:function(){this._completeCount++,this._loadCount===this._completeCount&&(this._completeCount=0,this._loadCount=0)}},{key:"load",value:function(t){var e=this;return this._loadCount++,new Promise(function(n,i){var s=new Image;s.onload=function(t){n(s),this.loadComplete()}.bind(e),s.onerror=function(t){i(t),this.loadComplete()}.bind(e),s.src=t})}},{key:"progress",get:function(){return this._loadCount<1?1:this._completeCount/this._loadCount}}]),t}(),s=function(){function t(){e.classCallCheck(this,t),this._colorBlending=.2,this._width=0,this._height=0,this._columns=0,this._rows=0,this._colors=[],this._source,this._pictures=new Map,this._canvas=document.createElement("canvas"),this._context=this._canvas.getContext("2d")}return e.createClass(t,[{key:"_getClosestColor",value:function(t){for(var e=this._colors[0],n=this._colors.length,i=Number.MAX_VALUE,s=t>>16&255,o=t>>8&255,r=255&t,h=0,a=0,u=0,c=0,l=0,_=0,f=0;n>f;f++){var d=this._colors[f];h=d>>16&255,a=d>>8&255,u=255&d,c=h-s,l=a-o,_=u-r;var g=Math.sqrt(c*c+l*l+_*_);if(0===g)return d;i>g&&(i=g,e=d)}return e}},{key:"setSize",value:function(t,e,n,i){this._columns=Number(n),this._rows=Number(i),this._width=Number(t),this._height=Number(e),this._canvas.width=this._width,this._canvas.height=this._height;for(var s=0;s<this._colors.length;s++){var o=this._colors[s];this._pictures[o].setSize(Math.floor(this._width/this._columns),Math.floor(this._height/this._rows))}}},{key:"addPicture",value:function(t){var e=t.averageColor;this._pictures[e]=t,this._colors.push(e)}},{key:"setSource",value:function(t){this._source=t,this.drawGrid()}},{key:"drawGrid",value:function(){for(var t=this._source.getImageData(),e=this._colorBlending,n=void 0,i=void 0,s=0,o=0,r=0,h=this._width/this._columns,a=this._height/this._rows,u=this._columns,c=(this._rows,this._context),l=t.length/4,_=0,f=0,d=0,g=void 0,m=0;l>m;m++)s=4*m,_=t[s],f=t[s+1],d=t[s+2],g=_<<16|f<<8|d,o=m%u*h,r=Math.floor(m/u)*a,1>e&&(n=this._getClosestColor(g),i=this._pictures[n],c.drawImage(i.canvas,o,r,h,a)),e>0&&(c.fillStyle="rgba("+_+", "+f+", "+d+", "+e+")",c.fillRect(o,r,h,a))}},{key:"poolSize",get:function(){return this._colors.length}},{key:"size",get:function(){return this._columns*this._rows}},{key:"colors",get:function(){return this._colors}},{key:"canvas",get:function(){return this._canvas}},{key:"context",get:function(){return this._context}},{key:"colorBlending",set:function(t){this._colorBlending=t},get:function(){return this._colorBlending}}]),t}(),o=(function(t,e){var n=t.exports;return function(t){function e(t){return"[object Array]"===Object.prototype.toString.call(t)}function i(){for(var t=0;t<S.length;t++)S[t][0](S[t][1]);S=[],v=!1}function s(t,e){S.push([t,e]),v||(v=!0,b(i,0))}function o(t,e){function n(t){a(e,t)}function i(t){c(e,t)}try{t(n,i)}catch(s){i(s)}}function r(t){var e=t.owner,n=e.state_,i=e.data_,s=t[n],o=t.then;if("function"==typeof s){n=p;try{i=s(i)}catch(r){c(o,r)}}h(o,i)||(n===p&&a(o,i),n===k&&c(o,i))}function h(t,e){var n;try{if(t===e)throw new TypeError("A promises callback cannot return that same promise.");if(e&&("function"==typeof e||"object"==typeof e)){var i=e.then;if("function"==typeof i)return i.call(e,function(i){n||(n=!0,e!==i?a(t,i):u(t,i))},function(e){n||(n=!0,c(t,e))}),!0}}catch(s){return n||c(t,s),!0}return!1}function a(t,e){t!==e&&h(t,e)||u(t,e)}function u(t,e){t.state_===w&&(t.state_=y,t.data_=e,s(_,t))}function c(t,e){t.state_===w&&(t.state_=y,t.data_=e,s(f,t))}function l(t){var e=t.then_;t.then_=void 0;for(var n=0;n<e.length;n++)r(e[n])}function _(t){t.state_=p,l(t)}function f(t){t.state_=k,l(t)}function d(t){if("function"!=typeof t)throw new TypeError("Promise constructor takes a function argument");if(this instanceof d==!1)throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this.then_=[],o(t,this)}var g=t.Promise,m=g&&"resolve"in g&&"reject"in g&&"all"in g&&"race"in g&&function(){var t;return new g(function(e){t=e}),"function"==typeof t}();"undefined"!=typeof n&&n?(n.Promise=m?g:d,n.Polyfill=d):"function"==typeof define&&define.amd?define(function(){return m?g:d}):m||(t.Promise=d);var v,w="pending",y="sealed",p="fulfilled",k="rejected",C=function(){},b="undefined"!=typeof setImmediate?setImmediate:setTimeout,S=[];d.prototype={constructor:d,state_:w,then_:null,data_:void 0,then:function(t,e){var n={owner:this,then:new this.constructor(C),fulfilled:t,rejected:e};return this.state_===p||this.state_===k?s(r,n):this.then_.push(n),n.then},"catch":function(t){return this.then(null,t)}},d.all=function(t){var n=this;if(!e(t))throw new TypeError("You must pass an array to Promise.all().");return new n(function(e,n){function i(t){return r++,function(n){o[t]=n,--r||e(o)}}for(var s,o=[],r=0,h=0;h<t.length;h++)s=t[h],s&&"function"==typeof s.then?s.then(i(h),n):o[h]=s;r||e(o)})},d.race=function(t){var n=this;if(!e(t))throw new TypeError("You must pass an array to Promise.race().");return new n(function(e,n){for(var i,s=0;s<t.length;s++)i=t[s],i&&"function"==typeof i.then?i.then(e,n):e(i)})},d.resolve=function(t){var e=this;return t&&"object"==typeof t&&t.constructor===e?t:new e(function(e){e(t)})},d.reject=function(t){var e=this;return new e(function(e,n){n(t)})}}("undefined"!=typeof window?window:"undefined"!=typeof e?e:"undefined"!=typeof self?self:this),t.exports}({exports:{}},t),function(){function t(n){e.classCallCheck(this,t),this._width=300,this._height=300,this._columns=10,this._rows=10,this._element,this._source,this._grid=new s,this._loader=new i,this._canvas=document.createElement("canvas"),this._canvas.width=this._width,this._canvas.height=this._height,this._context=this._canvas.getContext("2d"),"undefined"!=typeof n&&this.setElement(n)}return e.createClass(t,[{key:"_parseChildElements",value:function(t){for(var e=void 0,n=0;n<t.children.length;n++)e=t.children[n],"link"===e.tagName.toLowerCase()&&("grid"===e.type?this.addToGridFromURL(e.href):"source"===e.type&&this.setSourceFromURL(e.href));t.innerHTML=""}},{key:"_applySettingsFromElement",value:function(t){this.colorBlending=r.getAttribute(t,"mosaic-colorblending",this.colorBlending),this.setSize(r.getAttribute(t,"mosaic-width",this._width),r.getAttribute(t,"mosaic-height",this._height),r.getAttribute(t,"mosaic-columns",this._columns),r.getAttribute(t,"mosaic-rows",this._rows))}},{key:"_onLoadStatusChange",value:function(){1==this._loader.progress&&this._source&&(this._grid.setSource(this._source),this.draw())}},{key:"draw",value:function(){this._context&&this._context.drawImage(this._grid.canvas,0,0,this._width,this._height)}},{key:"setElement",value:function(t){this._element=t,this._applySettingsFromElement(this._element),this._element.innerHTML&&this._parseChildElements(this._element),this._element.appendChild(this._canvas)}},{key:"setSize",value:function(){var t=arguments.length<=0||void 0===arguments[0]?0:arguments[0],e=arguments.length<=1||void 0===arguments[1]?0:arguments[1],n=arguments.length<=2||void 0===arguments[2]?0:arguments[2],i=arguments.length<=3||void 0===arguments[3]?0:arguments[3];this._width=t?Number(t):this._width,this._height=e?Number(e):this._height,this._columns=n?Number(n):this._columns,this._rows=i?Number(i):this._rows,this._canvas.width=this._width,this._canvas.height=this._height,this._grid.setSize(this._width,this._height,this._columns,this._rows),this._source&&this._grid.poolSize>0&&(this._source.setSize(this._columns,this._rows,this.pixelAspectRatio),this._grid.drawGrid(),this.draw())}},{key:"setSourceFromURL",value:function(t){var e=this;this._loader.load(t).then(function(t){e.setSourceImage(t)})["catch"](function(e){console.warn("[mosaic.js] Error loading "+t+":",e)}).then(function(){})}},{key:"setSourceImage",value:function(t){this._source=new n(t,this._columns,this._rows,this.pixelAspectRatio),this._onLoadStatusChange()}},{key:"addToGridFromURL",value:function(t){var e=this;this._loader.load(t).then(function(t){e.addToGrid(t)})["catch"](function(e){console.warn("[mosaic.js] Error loading "+t+":",e)}).then(function(){if(1==e._loader.progress)e._onLoadStatusChange();else{Math.round(100*e._loader.progress)}})}},{key:"addToGrid",value:function(t){var e=new n(t,Math.floor(this._width/this._columns),Math.floor(this._height/this._rows));this._grid.addPicture(e)}},{key:"colorBlending",set:function(t){this._grid.colorBlending=t},get:function(){return this._grid.colorBlending}},{key:"loadProgress",get:function(){return this._loader.progress}},{key:"canvas",get:function(){return this._canvas}},{key:"pixelAspectRatio",get:function(){return this._width/this._columns/(this._height/this._rows)}},{key:"width",set:function(t){this.setSize(Number(t))},get:function(){return this._width}},{key:"height",set:function(t){this.setSize(0,Number(t))},get:function(){return this._height}},{key:"columns",set:function(t){this.setSize(0,0,Number(t))},get:function(){return this._columns}},{key:"rows",set:function(t){this.setSize(0,0,0,Number(t))},get:function(){return this._rows}}]),t}()),r=function(){function t(){e.classCallCheck(this,t)}return e.createClass(t,null,[{key:"getAttribute",value:function(t,e){var n=arguments.length<=2||void 0===arguments[2]?"":arguments[2],i=t.getAttribute(e);return i?i:n}},{key:"setStyles",value:function(t,e){e=e?e:{};for(var n in e)t.style[n]=e[n]}}]),t}();return o}();